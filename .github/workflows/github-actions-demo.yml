name: B-U585I-IOT02A-demo

on:
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: pull
        uses: actions/checkout@v2
      - name: build
        run: |
          sudo apt install gcc-arm-none-eabi
          cd ${{ github.workspace }}/STM32CubeIDE/workspace_1.9.0/IOT_HTTP_WebServer/STM32CubeIDE/Debug/
          make -j7 all
          arm-none-eabi-objcopy -O binary ${{ github.workspace }}/STM32CubeIDE/workspace_1.9.0/IOT_HTTP_WebServer/STM32CubeIDE/Debug/IOT_HTTP_WebServer.elf ${{ github.workspace }}/STM32CubeIDE/workspace_1.9.0/IOT_HTTP_WebServer/STM32CubeIDE/Debug/IOT_HTTP_WebServer.bin
      - name: upload-bin
        uses: actions/upload-artifact@master
        with:
          name: IOT_HTTP_WebServer.bin
          path: ${{ github.workspace }}/STM32CubeIDE/workspace_1.9.0/IOT_HTTP_WebServer/STM32CubeIDE/Debug/IOT_HTTP_WebServer.bin
      - name: upload-elf
        uses: actions/upload-artifact@master
        with:
          name: IOT_HTTP_WebServer.elf
          path: ${{ github.workspace }}/STM32CubeIDE/workspace_1.9.0/IOT_HTTP_WebServer/STM32CubeIDE/Debug/IOT_HTTP_WebServer.elf
  virtual-device-test:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: pull tests
        uses: actions/checkout@v2
      - name: pull libs
        run: |
          git clone https://github.com/ARM-software/avh-api.git
      - name: download-elf
        uses: actions/download-artifact@master
        with:
          name: IOT_HTTP_WebServer.elf
          path: ${{ github.workspace }}/avh-api/python/examples/assets
      - name: test
        run: |
          pip3 install websockets six python-dateutil urllib3 aiohttp
          npm install @openapitools/openapi-generator-cli -g
          cp ${{ github.workspace }}/virtual-device-test.py ${{ github.workspace }}/avh-api/python/examples/async/.
          cd avh-api/python
          make examples/async/virtual-device-test.py
  physical-device-test:
    runs-on: self-hosted
    needs: build
    steps:
      - name: pull
        uses: actions/checkout@v2
      - name: download-bin
        uses: actions/download-artifact@master
        with:
          name: IOT_HTTP_WebServer.bin
          path: ${{ github.workspace }}
      - name: test
        run: |
          echo "cp ${{ github.workspace }}/IOT_HTTP_WebServer.bin /media/mrrumpf/DIS_U585AI/."
          cp ${{ github.workspace }}/IOT_HTTP_WebServer.bin /media/mrrumpf/DIS_U585AI/.
          npm install split2 promise-socket
          sleep 10
          node physical-device-test.js